事故心得
====
### zk配置错误导致实例初始化失败

**事故描述：**<br>
一个SDK使用zk存储配置数据，修改zk配置时，数据配置错误，新的配置未加载成功，按照业务逻辑继续使用旧的配置。过了几个星期，重启服务，配置加载不成功，创建SDK中的java对象时抛出异常；SDK调用方没有cache住相应异常，不停的的尝试创建实例对象，直接导致调用方的整体服务挂掉；

**工作不足之处：**<br>
SDK配置失败没能及时发现、调用方没有处理好异常、调用方定位问题耗时很长

**修复：**<br>
增加配置监控，每次修改zk配置确保正确生效；调用方处理好异常；调用方业务架构不合理，调整架构(实际上SDK提供的服务出问题之后，暂停SDK的服务而不应该影响整体服务)

**心得:**<br>
业务方服务很多，涉及到kafka、hbase、zk、hdfs以及自身的许多RPC服务，平时告警比较多，经常忽略告警；**保证监控告警的有效性与业务平时的质量很重要**。 这次出问题时，最先观察到的是跟hbase服务相关的问题，而且hbase和kafka也是经常比较容易出问题的地方，所以他们先联系运维排查hbase，kafka等相关问题，就耽搁了很多时间。**对于高并发业务，合理完善的服务架构，能够快速的定位问题很关键，预防问题>快速定位问题>尽可能保证业务可用性>查找问题原因>解决问题** 对于高并发的一些问题，出问题时的一些情况状态很难完全记录，事后也很难复现问题，导致查找原因以及解决起来非常的耗时。



### zk频繁连接、断开导致频繁执行onChange逻辑，大量消耗机器资源

### 压力增大导致api服务可用性不达标
**事故描述**：<br>
客户端短时间覆盖了大量用户，由于redis连接池配置不合理以及使用不当，导致缓存穿透，同时数据库连接池配置不合理（实际是配置不生效，使用默认配置）导致对mysql服务器造成了很大压力；

**问题原因：**<br>
redis配置不合理，redis使用不合理，mysql配置未生效；缺少压测环节；

### 访问MYSQL服务未指定走读服务器，导致时而取到时而取不到数据

**问题描述**<br>
staging环境测试正常，上线之后发现有时候正常，有时候读取不到数据。

**不足之处**<br>
当时第一反应是在服务内部，多次尝试读取减少异常请求的发生。然而这实在是下下策。在高并发的情况下这样做，这种做法往往会让事情变得更糟，因此临时下线，只保留一台机器线上测试！

**问题原因**<br>
项目中连接的数据库使用了主从配置，并且主服务器只负责写数据不允许读数据。但是在写DAO层取数据接口的时候，并没有指定走读服务器，导致时而走读服务器时可以取到数据，走主服务器时取不到数据。

**修复**<br>
设置走服务器即可
